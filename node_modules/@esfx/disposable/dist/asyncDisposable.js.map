{"version":3,"file":"asyncDisposable.js","sourceRoot":"","sources":["../src/asyncDisposable.ts"],"names":[],"mappings":"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","sourcesContent":["/*!\r\n   Copyright 2019 Ron Buckton\r\n\r\n   Licensed under the Apache License, Version 2.0 (the \"License\");\r\n   you may not use this file except in compliance with the License.\r\n   You may obtain a copy of the License at\r\n\r\n       http://www.apache.org/licenses/LICENSE-2.0\r\n\r\n   Unless required by applicable law or agreed to in writing, software\r\n   distributed under the License is distributed on an \"AS IS\" BASIS,\r\n   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n   See the License for the specific language governing permissions and\r\n   limitations under the License.\r\n*/\r\n\r\nimport { Disposable } from \"./disposable\";\r\nimport { weakAsyncDisposableResourceStack, weakAsyncDisposableState } from \"./internal/asyncDisposable\";\r\nimport { AddDisposableResource, asyncDisposeSym, createDeprecation, CreateScope, DisposableResourceRecord, DisposeResources, ThrowCompletion } from \"./internal/utils\";\r\n\r\n/* @internal */\r\nexport const reportAsyncDisposableCreateDeprecation = createDeprecation(\"Use 'new AsyncDisposable(dispose)' instead.\");\r\n/* @internal */\r\nexport const reportAsyncDisposableUseDeprecation = createDeprecation(\"Use 'AsyncDisposable.scope()' instead.\");\r\n/* @internal */\r\nexport const reportAsyncDisposableFromDeprecation = createDeprecation(\"'AsyncDisposable.from()' is unsafe. Use 'new AsyncDisposableStack' and 'AsyncDisposableStack.prototype.use' instead.\");\r\n\r\n/**\r\n * Indicates an object that has resources that can be explicitly disposed asynchronously.\r\n */\r\nexport interface AsyncDisposable {\r\n    /**\r\n     * Dispose this object's resources.\r\n     */\r\n    [AsyncDisposable.asyncDispose](): Promise<void>;\r\n}\r\n\r\nexport type AsyncDisposableLike = AsyncDisposable | Disposable | (() => void | PromiseLike<void>);\r\n\r\n/**\r\n * Indicates an object that has resources that can be explicitly disposed asynchronously.\r\n *\r\n * NOTE: It is not necessary to subclass `Disposable`. Merely having a `[Disposable.dispose]()` method is sufficient.\r\n */\r\nexport class AsyncDisposable {\r\n    /**\r\n     * A well-known symbol used to define an async explicit resource disposal method on an object.\r\n     *\r\n     * Uses `Symbol.asyncDispose` if present.\r\n     */\r\n    static readonly asyncDispose: unique symbol = asyncDisposeSym;\r\n\r\n    /**\r\n     * Creates an `AsyncDisposable` wrapper around a callback used to dispose resources.\r\n     */\r\n    constructor(onDispose: () => void | PromiseLike<void>) {\r\n        if (typeof onDispose !== \"function\") throw new TypeError(\"Function expected: dispose\");\r\n        weakAsyncDisposableState.set(this, \"pending-one\");\r\n        weakAsyncDisposableResourceStack.set(this, [{ hint: \"async\", resource: null, dispose: onDispose }]);\r\n    }\r\n\r\n    /* @internal */\r\n    async [asyncDisposeSym]() {\r\n        const disposableState = weakAsyncDisposableState.get(this);\r\n        if (disposableState === \"disposed\") return;\r\n        if (disposableState !== \"pending\" && disposableState !== \"pending-one\") throw new TypeError(\"Wrong target\");\r\n        weakAsyncDisposableState.set(this, \"disposed\");\r\n\r\n        await DisposeResources(\"async\", weakAsyncDisposableResourceStack.get(this), disposableState === \"pending-one\", /*completion*/ undefined);\r\n    }\r\n\r\n    /**\r\n     * Creates an `AsyncDisposable` wrapper around a set of other disposables.\r\n     * @param resources An `Iterable` of `AsyncDisposable` or `Disposable` objects.\r\n     * @deprecated Use `new AsyncDisposableStack` and `AsyncDisposableStack.prototype.use()` instead. Creating a disposable object from an array is\r\n     * considered unsafe, as an exception raised when allocating a later disposable could result in an earlier disposable not being disposed:\r\n     * ```js\r\n     * AsyncDisposable.from([getResourceX(), getResourceY()])\r\n     * //                    ^^^^^^^^^^^^^^  ^^^^^^^^^^^^^^\r\n     * //                    |               |\r\n     * //                    allocated, but  throws\r\n     * //                    not disposed\r\n     * ```\r\n     */\r\n    static async from(resources: AsyncIterable<AsyncDisposableLike | null | undefined> | Iterable<AsyncDisposableLike | null | undefined | PromiseLike<AsyncDisposableLike | null | undefined>>) {\r\n        reportAsyncDisposableFromDeprecation();\r\n        const disposableResourceStack: DisposableResourceRecord<\"async\">[] = [];\r\n        const errors: unknown[] = [];\r\n\r\n        let throwCompletion: ThrowCompletion | undefined;\r\n        try {\r\n            for await (const resource of resources) {\r\n                try {\r\n                    AddDisposableResource(disposableResourceStack, resource, \"async\");\r\n                }\r\n                catch (e) {\r\n                    errors.push(e);\r\n                }\r\n            }\r\n        }\r\n        catch (e) {\r\n            throwCompletion = { cause: e };\r\n        }\r\n        finally {\r\n            if (errors.length || throwCompletion) {\r\n                await DisposeResources(\"async\", disposableResourceStack, /*suppress*/ false, throwCompletion, errors);\r\n            }\r\n        }\r\n\r\n        const disposable: AsyncDisposable = Object.create(__AsyncDisposable_prototype__);\r\n        weakAsyncDisposableState.set(disposable, \"pending\");\r\n        weakAsyncDisposableResourceStack.set(disposable, disposableResourceStack);\r\n        return disposable;\r\n    }\r\n\r\n    /**\r\n     * Emulate `using await const` using `for..await..of`.\r\n     *\r\n     * @example\r\n     * ```ts\r\n     * // with `using await const` (proposed)\r\n     * {\r\n     *   ...\r\n     *   using await const x = expr, y = expr;\r\n     *   ...\r\n     * }\r\n     *\r\n     * // with `AsyncDisposable.scope()`:\r\n     * for await (const { using, fail } of AsyncDisposable.scope()) {\r\n     *   try {\r\n     *     ...\r\n     *     const x = using(expr), y = using(expr);\r\n     *     ...\r\n     *   }\r\n     *   catch (e) {\r\n     *     fail(e);\r\n     *   }\r\n     * }\r\n     * ```\r\n     */\r\n    static async * scope(): AsyncGenerator<AsyncDisposableScope, void, undefined> {\r\n        const context = CreateScope(\"async\");\r\n        try {\r\n            context.state = \"initialized\";\r\n            yield context.scope;\r\n            context.state = \"exiting\";\r\n        }\r\n        finally {\r\n            context.state = \"done\";\r\n            await DisposeResources(\"async\", context.disposables, /*suppress*/ false, context.throwCompletion);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Yields each disposable in the iterable, disposing it when the generator resumes.\r\n     *\r\n     * This emulates `for (using await const x of expr)`.\r\n     *\r\n     * @example\r\n     * ```ts\r\n     * // with `using await const` (proposed)\r\n     * for (using await const x of expr) {\r\n     *   ...\r\n     * }\r\n     * for await (using await const x of expr) {\r\n     *   ...\r\n     * }\r\n     *\r\n     * // with `Disposable.usingEach()`:\r\n     * for await (const x of Disposable.usingEach(expr)) {\r\n     *   ...\r\n     * }\r\n     * ```\r\n     */\r\n    static async * usingEach(iterable: AsyncIterable<AsyncDisposableLike | null | undefined> | Iterable<AsyncDisposableLike | null | undefined | PromiseLike<AsyncDisposableLike | null | undefined>>) {\r\n        for await (const disposable of iterable) {\r\n            for await (const { using, fail } of AsyncDisposable.scope()) try {\r\n                yield using(disposable);\r\n            } catch (e) { fail(e); }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Executes a callback with the provided `AsyncDisposable` resource, disposing the resource when the callback completes asynchronously.\r\n     * @deprecated Use `AsyncDisposable.scope()` instead.\r\n     */\r\n    static async use<T extends AsyncDisposableLike | null | undefined, U>(resource: T, callback: (resource: T) => U | PromiseLike<U>) {\r\n        reportAsyncDisposableUseDeprecation();\r\n        for await (const { using, fail } of AsyncDisposable.scope()) {\r\n            try {\r\n                return callback(using(resource));\r\n            }\r\n            catch (e) {\r\n                fail(e);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Determines whether a value is `AsyncDisposable`.\r\n     */\r\n    static hasInstance(value: unknown): value is AsyncDisposable {\r\n        return typeof value === \"object\"\r\n            && value !== null\r\n            && asyncDisposeSym in value;\r\n    }\r\n\r\n    /**\r\n     * Determines whether a value is `AsyncDisposable`.\r\n     */\r\n    static [Symbol.hasInstance](value: unknown): value is AsyncDisposable {\r\n        return AsyncDisposable.hasInstance(value);\r\n    }\r\n}\r\n\r\n/* @internal */\r\nexport const __AsyncDisposable_prototype__ = AsyncDisposable.prototype;\r\n\r\nObject.defineProperty(__AsyncDisposable_prototype__, Symbol.toStringTag, { configurable: true, value: \"AsyncDisposable\" });\r\nObject.defineProperty(AsyncDisposable, Symbol.hasInstance, Object.getOwnPropertyDescriptor(AsyncDisposable, \"hasInstance\")!);\r\n\r\nexport namespace AsyncDisposable {\r\n    /**\r\n     * Creates an `AsyncDisposable` wrapper around a callback used to dispose resources.\r\n     * @deprecated Use `new AsyncDisposable(dispose)` instead.\r\n     */\r\n    export function create(dispose: () => void | PromiseLike<void>): AsyncDisposable {\r\n        reportAsyncDisposableCreateDeprecation();\r\n        return new AsyncDisposable(dispose);\r\n    }\r\n}\r\n\r\nexport interface AsyncDisposableScope {\r\n    /**\r\n     * Tracks a resource to be disposed at the end of a `for..of` statement. See {@link AsyncDisposable.scope}.\r\n     */\r\n    using<T extends AsyncDisposableLike | null | undefined>(value: T): T;\r\n\r\n    /**\r\n     * Tracks an exception from the body of a `for..of` statement. See {@link AsyncDisposable.scope}.\r\n     */\r\n    fail(error: unknown): void;\r\n}\r\n"]}