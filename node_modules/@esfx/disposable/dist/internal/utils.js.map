{"version":3,"file":"utils.js","sourceRoot":"","sources":["../../src/internal/utils.ts"],"names":[],"mappings":";AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EAiCE;;;AASF,eAAe;AACF,QAAA,UAAU,GAA8B,SAAS,CAAC,SAAS,EAAE,qCAAqC,CAA8B,CAAC;AAE9I,eAAe;AACF,QAAA,eAAe,GAAwC,SAAS,CAAC,cAAc,EAAE,+CAA+C,CAAwC,CAAC;AAEtL,eAAe;AACF,QAAA,IAAI,GAAyF,QAAQ,CAAC,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;AAOhK,eAAe;AACf,SAAgB,qBAAqB,CAAgC,uBAAyD,EAAE,CAAU,EAAE,IAAU;IAClJ,IAAI,CAAC,KAAK,IAAI,IAAI,CAAC,KAAK,SAAS;QAAE,OAAO;IAC1C,IAAI,OAAO,CAAC,KAAK,QAAQ,IAAI,OAAO,CAAC,KAAK,UAAU;QAAE,MAAM,IAAI,SAAS,CAAC,iBAAiB,CAAC,CAAC;IAC7F,MAAM,QAAQ,GAAG,wBAAwB,CAAC,CAAW,EAAE,IAAI,CAAC,CAAC;IAC7D,uBAAuB,CAAC,uBAAuB,CAAC,MAAM,CAAC,GAAG,QAAQ,CAAC;AACvE,CAAC;AALD,sDAKC;AAED,eAAe;AACf,SAAgB,wBAAwB,CAAgC,QAAgB,EAAE,IAAU;IAChG,MAAM,OAAO,GAAG,gBAAgB,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAC;IACjD,IAAI,OAAO,KAAK,SAAS,EAAE;QACvB,IAAI,OAAO,QAAQ,KAAK,UAAU,EAAE;YAChC,OAAO,EAAE,IAAI,EAAE,QAAQ,EAAE,IAAI,EAAE,OAAO,EAAE,QAA+B,EAAE,CAAC;SAC7E;QACD,MAAM,IAAI,SAAS,CAAC,IAAI,KAAK,OAAO,CAAC,CAAC,CAAC,6BAA6B,CAAC,CAAC,CAAC,uBAAuB,CAAC,CAAC;KACnG;IACD,OAAO,EAAE,IAAI,EAAE,QAAQ,EAAE,OAAO,EAAoC,CAAC;AACzE,CAAC;AATD,4DASC;AAED,eAAe;AACf,SAAgB,gBAAgB,CAAgC,QAAgB,EAAE,IAAU;IACxF,IAAI,MAAuC,CAAC;IAC5C,IAAI,IAAI,KAAK,OAAO,EAAE;QAClB,MAAM,GAAG,SAAS,CAAC,QAA2B,EAAE,uBAAe,CAAC,CAAC;KACpE;IACD,IAAI,MAAM,KAAK,SAAS,EAAE;QACtB,MAAM,GAAG,SAAS,CAAC,QAAsB,EAAE,kBAAU,CAAC,CAAC;KAC1D;IACD,OAAO,MAAM,CAAC;AAClB,CAAC;AATD,4CASC;AAED,eAAe;AACf,SAAgB,SAAS,CAAuB,CAAI,EAAE,CAAI;IACtD,MAAM,IAAI,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;IAClB,IAAI,IAAI,KAAK,IAAI,IAAI,IAAI,KAAK,SAAS;QAAE,OAAO,SAAS,CAAC;IAC1D,IAAI,OAAO,IAAI,KAAK,UAAU;QAAE,MAAM,IAAI,SAAS,CAAC,YAAY,OAAO,CAAC,KAAK,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC,QAAQ,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,qBAAqB,CAAC,CAAC;IAC/I,OAAO,IAAI,CAAC;AAChB,CAAC;AALD,8BAKC;AAED,eAAe;AACf,SAAgB,OAAO,CAAgC,CAAgB,EAAE,IAAU,EAAE,MAA2B;IAC5G,OAAO,IAAI,KAAK,OAAO,CAAC,CAAC,CAAC,SAAS,EAAE,CAAC,CAAC,CAAC,QAAQ,EAAE,CAAC;IAEnD,SAAS,QAAQ;QACb,IAAA,YAAI,EAAC,MAAM,EAAE,CAAC,CAAC,CAAC;IACpB,CAAC;IAED,KAAK,UAAU,SAAS;QACpB,MAAM,MAAM,GAAG,IAAA,YAAI,EAAC,MAAM,EAAE,CAAC,CAAC,CAAC;QAC/B,IAAI,MAAM,KAAK,SAAS;YAAE,MAAM,MAAM,CAAC;IAC3C,CAAC;AACL,CAAC;AAXD,0BAWC;AAED,eAAe;AACf,SAAgB,gBAAgB,CAAgC,IAAU,EAAE,uBAAqE,EAAE,QAAiB,EAAE,eAA4C,EAAE,SAAoB,EAAE;IACtO,OAAO,CAAC,IAAI,KAAK,OAAO,CAAC,CAAC,CAAC,SAAS,EAAE,CAAC,CAAC,CAAC,QAAQ,EAAE,CAAuD,CAAC;IAE3G,SAAS,QAAQ;QACb,IAAI,uBAAuB,KAAK,SAAS,EAAE;YACvC,KAAK,IAAI,CAAC,GAAG,uBAAuB,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC,IAAI,CAAC,EAAE,CAAC,EAAE,EAAE;gBAC1D,MAAM,QAAQ,GAAG,uBAAuB,CAAC,CAAC,CAAC,CAAC;gBAC5C,IAAI;oBACA,OAAO,CAAC,QAAQ,CAAC,QAAQ,EAAE,QAAQ,CAAC,IAAI,EAAE,QAAQ,CAAC,OAAO,CAAC,CAAC;iBAC/D;gBACD,OAAO,CAAC,EAAE;oBACN,IAAI,QAAQ,EAAE;wBACV,MAAM,CAAC,MAAM,GAAG,CAAC,CAAC;wBAClB,eAAe,GAAG,EAAE,KAAK,EAAE,CAAC,EAAE,CAAC;qBAClC;yBACI;wBACD,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;qBAC7B;iBACJ;aACJ;SACJ;QACD,IAAI,MAAM,CAAC,MAAM,GAAG,CAAC;YAAE,mBAAmB,CAAC,MAAM,EAAE,eAAe,EAAE,gBAAgB,CAAC,CAAC;QACtF,IAAI,eAAe;YAAE,MAAM,eAAe,CAAC,KAAK,CAAC;IACrD,CAAC;IAED,KAAK,UAAU,SAAS;QACpB,IAAI,uBAAuB,KAAK,SAAS,EAAE;YACvC,KAAK,IAAI,CAAC,GAAG,uBAAuB,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC,IAAI,CAAC,EAAE,CAAC,EAAE,EAAE;gBAC1D,MAAM,QAAQ,GAAG,uBAAuB,CAAC,CAAC,CAAC,CAAC;gBAC5C,IAAI;oBACA,MAAM,MAAM,GAAG,OAAO,CAAC,QAAQ,CAAC,QAAQ,EAAE,QAAQ,CAAC,IAAI,EAAE,QAAQ,CAAC,OAAO,CAAC,CAAC;oBAC3E,IAAI,MAAM,KAAK,SAAS;wBAAE,MAAM,MAAM,CAAC;iBAC1C;gBACD,OAAO,CAAC,EAAE;oBACN,IAAI,QAAQ,EAAE;wBACV,MAAM,CAAC,MAAM,GAAG,CAAC,CAAC;wBAClB,eAAe,GAAG,EAAE,KAAK,EAAE,CAAC,EAAE,CAAC;qBAClC;yBACI;wBACD,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;qBAC7B;iBACJ;aACJ;SACJ;QACD,IAAI,MAAM,CAAC,MAAM,GAAG,CAAC;YAAE,mBAAmB,CAAC,MAAM,EAAE,eAAe,EAAE,gBAAgB,CAAC,CAAC;QACtF,IAAI,eAAe;YAAE,MAAM,eAAe,CAAC,KAAK,CAAC;IACrD,CAAC;AACL,CAAC;AA/CD,4CA+CC;AA+BD,eAAe;AACf,SAAgB,WAAW,CAAgC,IAAU;IACjE,+HAA+H;IAC/H,0DAA0D;IAC1D,gJAAgJ;IAChJ,MAAM,OAAO,GAAuB;QAChC,KAAK,EAAE,MAAM,CAAC,MAAM,CAAC;YACjB,KAAK,CAAC,QAAQ;gBACV,IAAI,OAAO,CAAC,KAAK,KAAK,aAAa;oBAAE,MAAM,IAAI,KAAK,CAAC,gBAAgB,CAAC,CAAC;gBACvE,qBAAqB,CAAC,OAAO,CAAC,WAAW,EAAE,QAAQ,EAAE,IAAI,CAAC,CAAC;gBAC3D,OAAO,QAAQ,CAAC;YACpB,CAAC;YACD,IAAI,CAAC,KAAK;gBACN,IAAI,OAAO,CAAC,KAAK,KAAK,aAAa;oBAAE,MAAM,IAAI,KAAK,CAAC,gBAAgB,CAAC,CAAC;gBACvE,OAAO,CAAC,eAAe,GAAG,EAAE,KAAK,EAAE,KAAK,EAAE,CAAC;YAC/C,CAAC;SACJ,CAAC;QACF,KAAK,EAAE,aAAa;QACpB,WAAW,EAAE,EAAE;QACf,eAAe,EAAE,SAAS;KAC7B,CAAC;IACF,OAAO,OAAO,CAAC;AACnB,CAAC;AArBD,kCAqBC;AAED,SAAS,mBAAmB,CAAC,MAAiB,EAAE,eAA4C,EAAE,iBAA2B,mBAAmB;IACxI,IAAI,KAAqB,CAAC;IAC1B,IAAI,OAAO,cAAc,KAAK,UAAU,EAAE;QACtC,KAAK,GAAG,IAAI,cAAc,CAAC,MAAM,CAAC,CAAC;KACtC;SACI;QACD,KAAK,GAAG,IAAI,KAAK,CAAC,6BAA6B,CAAmB,CAAC;QACnE,KAAK,CAAC,IAAI,GAAG,gBAAgB,CAAC;QAC9B,KAAK,CAAC,MAAM,GAAG,MAAM,CAAC;KACzB;IACD,IAAI,eAAe,EAAE;QACjB,MAAM,CAAC,cAAc,CAAC,KAAK,EAAE,OAAO,EAAE,EAAE,YAAY,EAAE,IAAI,EAAE,QAAQ,EAAE,IAAI,EAAE,KAAK,EAAE,eAAe,CAAC,KAAK,EAAE,CAAC,CAAC;KAC/G;IACD,IAAI,KAAK,CAAC,iBAAiB,EAAE;QACzB,KAAK,CAAC,iBAAiB,CAAC,KAAK,EAAE,cAAc,CAAC,CAAC;KAClD;IACD,MAAM,KAAK,CAAC;AAChB,CAAC;AAED,eAAe;AACf,SAAS,SAAS,CAAC,iBAAyB,EAAE,gBAAwB;IAClE,MAAM,aAAa,GAAY,MAAc,CAAC,iBAAiB,CAAC,CAAC;IACjE,OAAO,OAAO,aAAa,KAAK,QAAQ,CAAC,CAAC,CAAC,aAAa,CAAC,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,gBAAgB,CAAC,CAAC;AAC5F,CAAC;AAQD,eAAe;AACf,SAAgB,iBAAiB,CAAC,OAAe;IAC7C,MAAM,WAAW,GAAgB,GAAG,EAAE;QAClC,IAAI,CAAC,WAAW,CAAC,QAAQ,EAAE;YACvB,WAAW,CAAC,QAAQ,GAAG,IAAI,CAAC;YAC5B,IAAI,OAAO,OAAO,KAAK,QAAQ,IAAI,OAAO,CAAC,WAAW,EAAE;gBACpD,OAAO,CAAC,WAAW,CAAC,OAAO,EAAE,oBAAoB,EAAE,WAAW,CAAC,CAAC;aACnE;iBACI,IAAI,OAAO,OAAO,KAAK,QAAQ,EAAE;gBAClC,OAAO,CAAC,IAAI,CAAC,gBAAgB,OAAO,EAAE,CAAC,CAAA;aAC1C;SACJ;IACL,CAAC,CAAA;IACD,OAAO,WAAW,CAAC;AACvB,CAAC;AAbD,8CAaC","sourcesContent":["/*!\r\n   Copyright 2019 Ron Buckton\r\n\r\n   Licensed under the Apache License, Version 2.0 (the \"License\");\r\n   you may not use this file except in compliance with the License.\r\n   You may obtain a copy of the License at\r\n\r\n       http://www.apache.org/licenses/LICENSE-2.0\r\n\r\n   Unless required by applicable law or agreed to in writing, software\r\n   distributed under the License is distributed on an \"AS IS\" BASIS,\r\n   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n   See the License for the specific language governing permissions and\r\n   limitations under the License.\r\n\r\n   THIRD PARTY LICENSE NOTICE:\r\n\r\n   CreateScope is derived from https://github.com/mhofman/disposator/ which\r\n   is licensed under the Apache 2.0 License:\r\n\r\n   Copyright 2021 Mathieu Hofman\r\n\r\n   Licensed under the Apache License, Version 2.0 (the \"License\");\r\n   you may not use this file except in compliance with the License.\r\n   You may obtain a copy of the License at\r\n\r\n       http://www.apache.org/licenses/LICENSE-2.0\r\n\r\n   Unless required by applicable law or agreed to in writing, software\r\n   distributed under the License is distributed on an \"AS IS\" BASIS,\r\n   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n   See the License for the specific language governing permissions and\r\n   limitations under the License.\r\n*/\r\n\r\n/* @internal */\r\nimport type { Disposable } from \"../disposable\";\r\n/* @internal */\r\nimport type { AsyncDisposable } from \"../asyncDisposable\";\r\n\r\nexport {};\r\n\r\n/* @internal */\r\nexport const disposeSym: typeof Disposable.dispose = GetSymbol(\"dispose\", \"@esfx/disposable:Disposable.dispose\") as typeof Disposable.dispose;\r\n\r\n/* @internal */\r\nexport const asyncDisposeSym: typeof AsyncDisposable.asyncDispose = GetSymbol(\"asyncDispose\", \"@esfx/disposable:AsyncDisposable.asyncDispose\") as typeof AsyncDisposable.asyncDispose;\r\n\r\n/* @internal */\r\nexport const Call: <T, A extends any[], R>(f: (this: T, ...args: A) => R, thisArg: T, ...args: A ) => R = Function.prototype.call.bind(Function.prototype.call);\r\n\r\n/* @internal */\r\nexport interface ThrowCompletion {\r\n    cause: unknown;\r\n}\r\n\r\n/* @internal */\r\nexport function AddDisposableResource<Hint extends \"sync\" | \"async\">(disposableResourceStack: DisposableResourceRecord<Hint>[], V: unknown, hint: Hint) {\r\n    if (V === null || V === undefined) return;\r\n    if (typeof V !== \"object\" && typeof V !== \"function\") throw new TypeError(\"Object expected\");\r\n    const resource = CreateDisposableResource(V as object, hint);\r\n    disposableResourceStack[disposableResourceStack.length] = resource;\r\n}\r\n\r\n/* @internal */\r\nexport function CreateDisposableResource<Hint extends \"sync\" | \"async\">(resource: object, hint: Hint): DisposableResourceRecord<Hint> {\r\n    const dispose = GetDisposeMethod(resource, hint);\r\n    if (dispose === undefined) {\r\n        if (typeof resource === \"function\") {\r\n            return { hint, resource: null, dispose: resource as DisposeMethod<Hint> };\r\n        }\r\n        throw new TypeError(hint === \"async\" ? \"Object not async disposable\" : \"Object not disposable\");\r\n    }\r\n    return { hint, resource, dispose } as DisposableResourceRecord<Hint>;\r\n}\r\n\r\n/* @internal */\r\nexport function GetDisposeMethod<Hint extends \"sync\" | \"async\">(resource: object, hint: Hint): DisposeMethod<Hint> | undefined {\r\n    let method: DisposeMethod<Hint> | undefined;\r\n    if (hint === \"async\") {\r\n        method = GetMethod(resource as AsyncDisposable, asyncDisposeSym);\r\n    }\r\n    if (method === undefined) {\r\n        method = GetMethod(resource as Disposable, disposeSym);\r\n    }\r\n    return method;\r\n}\r\n\r\n/* @internal */\r\nexport function GetMethod<T, K extends keyof T>(V: T, P: K) {\r\n    const func = V[P];\r\n    if (func === null || func === undefined) return undefined;\r\n    if (typeof func !== \"function\") throw new TypeError(`Property ${typeof P === \"symbol\" ? P.toString() : JSON.stringify(P)} is not a function.`);\r\n    return func;\r\n}\r\n\r\n/* @internal */\r\nexport function Dispose<Hint extends \"sync\" | \"async\">(V: object | null, hint: Hint, method: DisposeMethod<Hint>) {\r\n    return hint === \"async\" ? execAsync() : execSync();\r\n\r\n    function execSync() {\r\n        Call(method, V);\r\n    }\r\n\r\n    async function execAsync() {\r\n        const result = Call(method, V);\r\n        if (result !== undefined) await result;\r\n    }\r\n}\r\n\r\n/* @internal */\r\nexport function DisposeResources<Hint extends \"sync\" | \"async\">(hint: Hint, disposableResourceStack: DisposableResourceRecord<Hint>[] | undefined, suppress: boolean, throwCompletion: ThrowCompletion | undefined, errors: unknown[] = []): Hint extends \"async\" ? Promise<void> | void : void {\r\n    return (hint === \"async\" ? execAsync() : execSync()) as Hint extends \"async\" ? Promise<void> | void : void;\r\n\r\n    function execSync() {\r\n        if (disposableResourceStack !== undefined) {\r\n            for (let i = disposableResourceStack.length - 1; i >= 0; i--) {\r\n                const resource = disposableResourceStack[i];\r\n                try {\r\n                    Dispose(resource.resource, resource.hint, resource.dispose);\r\n                }\r\n                catch (e) {\r\n                    if (suppress) {\r\n                        errors.length = 0;\r\n                        throwCompletion = { cause: e };\r\n                    }\r\n                    else {\r\n                        errors[errors.length] = e;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        if (errors.length > 0) ThrowAggregateError(errors, throwCompletion, DisposeResources);\r\n        if (throwCompletion) throw throwCompletion.cause;\r\n    }\r\n\r\n    async function execAsync() {\r\n        if (disposableResourceStack !== undefined) {\r\n            for (let i = disposableResourceStack.length - 1; i >= 0; i--) {\r\n                const resource = disposableResourceStack[i];\r\n                try {\r\n                    const result = Dispose(resource.resource, resource.hint, resource.dispose);\r\n                    if (result !== undefined) await result;\r\n                }\r\n                catch (e) {\r\n                    if (suppress) {\r\n                        errors.length = 0;\r\n                        throwCompletion = { cause: e };\r\n                    }\r\n                    else {\r\n                        errors[errors.length] = e;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        if (errors.length > 0) ThrowAggregateError(errors, throwCompletion, DisposeResources);\r\n        if (throwCompletion) throw throwCompletion.cause;\r\n    }\r\n}\r\n\r\ntype DisposeMethod<Hint extends \"sync\" | \"async\"> =\r\n    Hint extends \"async\" ?\r\n        ((this: object | null) => void | PromiseLike<void>) :\r\n        ((this: object | null) => void);\r\n\r\ntype ScopeResource<Hint extends \"sync\" | \"async\"> =\r\n    Hint extends \"async\" ?\r\n        AsyncDisposable :\r\n        Disposable;\r\n\r\n/* @internal */\r\nexport interface DisposableResourceRecord<Hint extends \"sync\" | \"async\"> {\r\n    hint: Hint;\r\n    resource: object | null;\r\n    dispose: DisposeMethod<Hint>;\r\n}\r\n\r\ninterface ScopeContext<Hint extends \"sync\" | \"async\"> {\r\n    scope: Scope<Hint>;\r\n    state: \"initialized\" | \"exiting\" | \"done\";\r\n    disposables: DisposableResourceRecord<Hint>[];\r\n    throwCompletion: ThrowCompletion | undefined;\r\n}\r\n\r\ninterface Scope<Hint extends \"sync\" | \"async\"> {\r\n    using<T extends ScopeResource<Hint> | Disposable | DisposeMethod<Hint> | null | undefined>(value: T): T;\r\n    fail(error: unknown): void;\r\n}\r\n\r\n/* @internal */\r\nexport function CreateScope<Hint extends \"sync\" | \"async\">(hint: Hint): ScopeContext<Hint> {\r\n    // Credit to Mathieu Hofman for initial `for (const { using } of Disposable)` mechanism: https://github.com/mhofman/disposator/\r\n    // See THIRD PARTY LICENSE NOTICE at the top of this file.\r\n    // Modified to return a `fail` callback to emulate error suppression semantics of https://github.com/tc39/proposal-explicit-resource-management/\r\n    const context: ScopeContext<Hint> = {\r\n        scope: Object.freeze({\r\n            using(resource) {\r\n                if (context.state !== \"initialized\") throw new Error(\"Illegal state.\");\r\n                AddDisposableResource(context.disposables, resource, hint);\r\n                return resource;\r\n            },\r\n            fail(error) {\r\n                if (context.state !== \"initialized\") throw new Error(\"Illegal state.\");\r\n                context.throwCompletion = { cause: error };\r\n            }\r\n        }),\r\n        state: \"initialized\",\r\n        disposables: [],\r\n        throwCompletion: undefined,\r\n    };\r\n    return context;\r\n}\r\n\r\nfunction ThrowAggregateError(errors: unknown[], throwCompletion: ThrowCompletion | undefined, stackCrawlMark: Function = ThrowAggregateError): never {\r\n    let error: AggregateError;\r\n    if (typeof AggregateError === \"function\") {\r\n        error = new AggregateError(errors);\r\n    }\r\n    else {\r\n        error = new Error(\"One or more errors occurred\") as AggregateError;\r\n        error.name = \"AggregateError\";\r\n        error.errors = errors;\r\n    }\r\n    if (throwCompletion) {\r\n        Object.defineProperty(error, \"cause\", { configurable: true, writable: true, value: throwCompletion.cause });\r\n    }\r\n    if (Error.captureStackTrace) {\r\n        Error.captureStackTrace(error, stackCrawlMark);\r\n    }\r\n    throw error;\r\n}\r\n\r\n/* @internal */\r\nfunction GetSymbol(builtInSymbolName: string, customSymbolName: string) {\r\n    const builtInSymbol: symbol = (Symbol as any)[builtInSymbolName];\r\n    return typeof builtInSymbol === \"symbol\" ? builtInSymbol : Symbol.for(customSymbolName);\r\n}\r\n\r\n/* @internal */\r\nexport interface Deprecation {\r\n    (): void;\r\n    reported?: boolean;\r\n}\r\n\r\n/* @internal */\r\nexport function createDeprecation(message: string) {\r\n    const deprecation: Deprecation = () => {\r\n        if (!deprecation.reported) {\r\n            deprecation.reported = true;\r\n            if (typeof process === \"object\" && process.emitWarning) {\r\n                process.emitWarning(message, \"DeprecationWarning\", deprecation);\r\n            }\r\n            else if (typeof console === \"object\") {\r\n                console.warn(`Deprecation: ${message}`)\r\n            }\r\n        }\r\n    }\r\n    return deprecation;\r\n}\r\n"]}